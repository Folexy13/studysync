<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gemini API Debug Tool</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .container {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    }
    
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    
    .input-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #555;
    }
    
    input, textarea {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      box-sizing: border-box;
    }
    
    input:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    
    button:hover {
      opacity: 0.9;
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .output {
      margin-top: 30px;
      padding: 20px;
      background: #f5f5f5;
      border-radius: 8px;
      min-height: 200px;
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      overflow-x: auto;
    }
    
    .success {
      background: #e8f5e9;
      border-left: 4px solid #4caf50;
    }
    
    .error {
      background: #ffebee;
      border-left: 4px solid #f44336;
    }
    
    .warning {
      background: #fff3e0;
      border-left: 4px solid #ff9800;
    }
    
    .info {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
    }
    
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 8px;
    }
    
    .json-viewer {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 20px;
      border-radius: 8px;
      overflow-x: auto;
      margin-top: 20px;
    }
    
    .json-key {
      color: #9cdcfe;
    }
    
    .json-string {
      color: #ce9178;
    }
    
    .json-number {
      color: #b5cea8;
    }
    
    .json-boolean {
      color: #569cd6;
    }
    
    .json-null {
      color: #569cd6;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Gemini API Debug Tool</h1>
    <p class="subtitle">Test your Gemini API key and debug response structures</p>
    
    <div class="input-group">
      <label for="apiKey">Gemini API Key:</label>
      <input type="password" id="apiKey" placeholder="Enter your Gemini API key">
    </div>
    
    <div class="input-group">
      <label for="testPrompt">Test Prompt:</label>
      <textarea id="testPrompt" rows="3">Hello, please respond with a simple greeting.</textarea>
    </div>
    
    <div class="input-group">
      <label for="model">Model:</label>
      <select id="model" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
        <option value="gemini-2.5-flash">gemini-2.5-flash (Recommended)</option>
        <option value="gemini-1.5-flash">gemini-1.5-flash</option>
        <option value="gemini-pro">gemini-pro</option>
      </select>
    </div>
    
    <button onclick="testAPI()">üöÄ Test API</button>
    <button onclick="testSummarize()">üìÑ Test Summarize</button>
    <button onclick="testQuestions()">‚ùì Test Questions</button>
    <button onclick="clearOutput()">üóëÔ∏è Clear Output</button>
    <button onclick="saveKey()">üíæ Save Key to Extension</button>
    
    <div id="status"></div>
    
    <div class="output" id="output">
      Ready to test. Enter your API key and click "Test API".
    </div>
    
    <div class="json-viewer" id="jsonViewer" style="display: none;">
      <h3 style="color: #fff; margin-top: 0;">üìä Raw JSON Response:</h3>
      <pre id="jsonContent"></pre>
    </div>
  </div>
  
  <script>
    let lastResponse = null;
    
    function showStatus(message, type = 'info') {
      const status = document.getElementById('status');
      status.className = `status ${type}`;
      status.textContent = message;
      status.style.display = 'block';
      
      if (type !== 'error') {
        setTimeout(() => {
          status.style.display = 'none';
        }, 5000);
      }
    }
    
    function formatJSON(obj) {
      return JSON.stringify(obj, null, 2)
        .replace(/"([^"]+)":/g, '<span class="json-key">"$1":</span>')
        .replace(/: "([^"]*)"/g, ': <span class="json-string">"$1"</span>')
        .replace(/: (\d+)/g, ': <span class="json-number">$1</span>')
        .replace(/: (true|false)/g, ': <span class="json-boolean">$1</span>')
        .replace(/: null/g, ': <span class="json-null">null</span>');
    }
    
    async function testAPI() {
      const apiKey = document.getElementById('apiKey').value.trim();
      const prompt = document.getElementById('testPrompt').value.trim();
      const model = document.getElementById('model').value;
      const output = document.getElementById('output');
      const jsonViewer = document.getElementById('jsonViewer');
      const jsonContent = document.getElementById('jsonContent');
      
      if (!apiKey) {
        showStatus('Please enter your API key', 'error');
        return;
      }
      
      if (!prompt) {
        showStatus('Please enter a test prompt', 'error');
        return;
      }
      
      output.textContent = 'Testing API...';
      output.className = 'output';
      jsonViewer.style.display = 'none';
      
      try {
        const endpoint = `https://generativelanguage.googleapis.com/v1/models/${model}:generateContent`;
        
        console.log('üöÄ Sending request to:', endpoint);
        
        const response = await fetch(`${endpoint}?key=${apiKey}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            contents: [{
              parts: [{
                text: prompt
              }]
            }],
            generationConfig: {
              temperature: 0.7,
              maxOutputTokens: 1024
            }
          })
        });
        
        const data = await response.json();
        lastResponse = data;
        
        console.log('üìä Full Response:', data);
        
        // Show raw JSON
        jsonViewer.style.display = 'block';
        jsonContent.innerHTML = formatJSON(data);
        
        if (response.ok) {
          output.className = 'output success';
          
          let extractedText = 'No text found in response';
          let debugInfo = [];
          
          // Try different paths to extract text
          if (data.candidates && data.candidates.length > 0) {
            const candidate = data.candidates[0];
            debugInfo.push(`‚úÖ Found ${data.candidates.length} candidate(s)`);
            
            // Path 1: Standard structure
            if (candidate.content?.parts?.[0]?.text) {
              extractedText = candidate.content.parts[0].text;
              debugInfo.push('‚úÖ Text found at: candidates[0].content.parts[0].text');
            }
            // Path 2: Alternative structure
            else if (candidate.output) {
              extractedText = candidate.output;
              debugInfo.push('‚úÖ Text found at: candidates[0].output');
            }
            // Path 3: Direct text
            else if (candidate.text) {
              extractedText = candidate.text;
              debugInfo.push('‚úÖ Text found at: candidates[0].text');
            }
            else {
              debugInfo.push('‚ùå No text found in standard paths');
              debugInfo.push('Available keys in candidate: ' + Object.keys(candidate).join(', '));
            }
          } else {
            debugInfo.push('‚ùå No candidates in response');
            debugInfo.push('Available keys in response: ' + Object.keys(data).join(', '));
          }
          
          output.textContent = `‚úÖ API Test Successful!\n\n` +
            `Debug Information:\n${debugInfo.join('\n')}\n\n` +
            `Extracted Text:\n${extractedText}\n\n` +
            `Response Structure:\n` +
            `- Has candidates: ${!!data.candidates}\n` +
            `- Candidates length: ${data.candidates?.length || 0}\n` +
            `- First candidate keys: ${data.candidates?.[0] ? Object.keys(data.candidates[0]).join(', ') : 'N/A'}`;
          
          showStatus('API test successful! Check the output for details.', 'success');
        } else {
          output.className = 'output error';
          output.textContent = `‚ùå API Error:\n\n` +
            `Status: ${response.status}\n` +
            `Error: ${data.error?.message || 'Unknown error'}\n\n` +
            `Full Response:\n${JSON.stringify(data, null, 2)}`;
          
          showStatus('API test failed. Check the output for details.', 'error');
        }
      } catch (error) {
        output.className = 'output error';
        output.textContent = `‚ùå Request Failed:\n\n${error.message}\n\n` +
          `This might be due to:\n` +
          `- Invalid API key\n` +
          `- Network issues\n` +
          `- CORS restrictions (try in extension context)`;
        
        showStatus('Request failed: ' + error.message, 'error');
        console.error('Error:', error);
      }
    }
    
    async function testSummarize() {
      const text = "Artificial intelligence is transforming how we interact with technology. Machine learning algorithms can now understand natural language, recognize images, and make predictions based on patterns in data. This has led to breakthroughs in healthcare, transportation, and communication.";
      document.getElementById('testPrompt').value = `Please summarize the following text concisely:\n\n${text}`;
      await testAPI();
    }
    
    async function testQuestions() {
      const text = "The water cycle is the continuous movement of water on Earth. Water evaporates from oceans and lakes, forms clouds, falls as precipitation, and returns to water bodies.";
      document.getElementById('testPrompt').value = `Generate 3 study questions from this text:\n\n${text}`;
      await testAPI();
    }
    
    function clearOutput() {
      document.getElementById('output').textContent = 'Ready to test. Enter your API key and click "Test API".';
      document.getElementById('output').className = 'output';
      document.getElementById('jsonViewer').style.display = 'none';
      document.getElementById('status').style.display = 'none';
    }
    
    async function saveKey() {
      const apiKey = document.getElementById('apiKey').value.trim();
      
      if (!apiKey) {
        showStatus('Please enter an API key first', 'error');
        return;
      }
      
      try {
        // Try to save to Chrome storage
        if (typeof chrome !== 'undefined' && chrome.storage) {
          await chrome.storage.sync.set({
            geminiApiKey: apiKey,
            geminiEndpoint: 'https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent'
          });
          showStatus('‚úÖ API key saved to extension!', 'success');
        } else {
          // Show manual instructions
          showStatus('Copy this key and paste it in the extension settings', 'warning');
        }
      } catch (error) {
        showStatus('Could not save directly. Copy the key and paste in extension settings.', 'warning');
      }
    }
    
    // Load saved key if available
    window.addEventListener('load', async () => {
      try {
        if (typeof chrome !== 'undefined' && chrome.storage) {
          const result = await chrome.storage.sync.get(['geminiApiKey']);
          if (result.geminiApiKey) {
            document.getElementById('apiKey').value = result.geminiApiKey;
            showStatus('Loaded saved API key', 'info');
          }
        }
      } catch (error) {
        console.log('Could not load saved key:', error);
      }
    });
  </script>
</body>
</html>